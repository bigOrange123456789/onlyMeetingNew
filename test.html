<!DOCTYPE html>
<html lang="en">
	<head>
		<title>MEETING--softwareTest</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {overflow:hidden;}
		</style>
	</head>

	<body>
	<!--有骨骼动画的着色器-->
	<script id="vertexShader" type="x-shader/x-vertex">
		precision highp float;//highp
		uniform mat4 modelViewMatrix;
		uniform mat4 projectionMatrix;

		uniform float skeletonMatrixInverse[400];//16*25
		uniform float skeletonMatrix[400];//16*25

		uniform float skeletonData[3000];//uniform float[]最大长度4088//变化范围12(0-11)
		uniform float time;//0-10000

		attribute vec3 position;
		attribute vec2 inUV;
        attribute vec4 skinIndex;
        attribute vec4 skinWeight;

        attribute float random;

		attribute float speed;

		attribute vec3 mcol0;
		attribute vec3 mcol1;
		attribute vec3 mcol2;
		attribute vec3 mcol3;

		attribute vec4 type;   //type[3]是0或1，用于表示动画
		attribute vec3 color;

        varying vec2 outUV;
        varying vec3 varyType;
        varying vec3 varyColor;
        varying float type_part;
        varying float myTest00;

        mat4 getMatrixs_i(int i){
        	return mat4(//最后一列是：0 0 0 1
				    	    skeletonMatrix[i*16+0] ,skeletonMatrix[i*16+1] ,skeletonMatrix[i*16+2] ,skeletonMatrix[i*16+3] ,
				  	      	skeletonMatrix[i*16+4] ,skeletonMatrix[i*16+5] ,skeletonMatrix[i*16+6] ,skeletonMatrix[i*16+7] ,
				    	    skeletonMatrix[i*16+8] ,skeletonMatrix[i*16+9] ,skeletonMatrix[i*16+10],skeletonMatrix[i*16+11],
				    	    skeletonMatrix[i*16+12],skeletonMatrix[i*16+13],skeletonMatrix[i*16+14],skeletonMatrix[i*16+15]
			    	    );
        }
		mat4 getMatrixs0_i(int iii){
					//float c=(a/b-floor(a/b))*b;//fmod(float a,float b)
					float t=((time*speed)/12.0-floor((time*speed)/12.0))*12.0;

					int frame_index=0;//=time%12;
					if(t>-0.5&&t<0.5)frame_index=0;
					else if(t>0.5&&t<1.5)frame_index=1;
					else if(t>1.5&&t<2.5)frame_index=2;
					else if(t>2.5&&t<3.5)frame_index=3;
					else if(t>3.5&&t<4.5)frame_index=4;
					else if(t>4.5&&t<5.5)frame_index=5;
					else if(t>5.5&&t<6.5)frame_index=6;
					else if(t>6.5&&t<7.5)frame_index=7;
					else if(t>7.5&&t<8.5)frame_index=8;
					else if(t>8.5&&t<9.5)frame_index=9;
					else if(t>9.5&&t<10.5)frame_index=10;
					else frame_index=11;
					//double test=double(time);
					//if(time=)
					float x,y,z,w,px,py,pz;
					float x2,y2,z2 ,
					      xx,xy,xz,
					      yy,yz,zz,
					      wx,wy,wz;
					px=skeletonData[250*frame_index+10*iii+0];
					py=skeletonData[250*frame_index+10*iii+1];
					pz=skeletonData[250*frame_index+10*iii+2];
					x=skeletonData[250*frame_index+10*iii+3];
					y=skeletonData[250*frame_index+10*iii+4];
					z=skeletonData[250*frame_index+10*iii+5];
					w=skeletonData[250*frame_index+10*iii+6];


					x2 = x + x;	y2 = y + y; z2 = z + z;
                    xx = x * x2;xy = x * y2;xz = x * z2;
                    yy = y * y2;yz = y * z2;zz = z * z2;
                    wx = w * x2;wy = w * y2;wz = w * z2;
                    return mat4(
                    	( 1.0-( yy + zz ) ),( xy + wz )        ,( xz - wy )          ,0.0,
                    	( xy - wz )        ,( 1.0-( xx + zz ) ) ,( yz + wx )         ,0.0,
                    	( xz + wy )      ,( yz - wx )         ,( 1.0-( xx + yy ) ) ,0.0,
                    	px                     ,py                       ,pz       ,1.0
                    );
		}
		/*mat4 getMatrixs0_i_0(int iii){//备用函数
					float x,y,z,w,sx,sy,sz,px,py,pz;
					float x2,y2,z2 ,
					      xx,xy,xz,
					      yy,yz,zz,
					      wx,wy,wz;
					px=skeletonData[250*time+10*iii+0];
					py=skeletonData[250*time+10*iii+1];
					pz=skeletonData[250*time+10*iii+2];
					x=skeletonData[250*time+10*iii+3];
					y=skeletonData[250*time+10*iii+4];
					z=skeletonData[250*time+10*iii+5];
					w=skeletonData[250*time+10*iii+6];
					//sx=skeletonData[250*time+10*iii+7];
					//sy=skeletonData[250*time+10*iii+8];
					//sz=skeletonData[250*time+10*iii+9];
					//px=py=pz=0.0;
					sx=sy=sz=1.0;


					x2 = x + x;	y2 = y + y; z2 = z + z;
                    xx = x * x2;xy = x * y2;xz = x * z2;
                    yy = y * y2;yz = y * z2;zz = z * z2;
                    wx = w * x2;wy = w * y2;wz = w * z2;
                    return mat4(
                    	( 1.0-( yy + zz ) ) * sx,( xy + wz ) * sx        ,( xz - wy ) * sx         ,0.0,
                    	( xy - wz ) * sy        ,( 1.0-( xx + zz ) ) * sy,( yz + wx ) * sy         ,0.0,
                    	( xz + wy ) * sz       ,( yz - wx ) * sz         ,( 1.0-( xx + yy ) ) * sz ,0.0,
                    	px                     ,py                       ,pz                       ,1.0
                    );
		}*/
		void main(){
			vec3 vPosition = position;
			//if(random<0.8)//显示百分之80三角面
			//if(vPosition.y<1.8)//全身显示
			//if(vPosition.y>0.61&&vPosition.x>0.0)//只显示脸

			//if(true)//全身显示
			//if(vPosition.x>-0.09)//前半部分
			//if((vPosition.x>-0.01&&vPosition.y>0.1)||vPosition.y>0.65)//只显示前半部分的上半身和头
			//if(vPosition.x>-0.01&&vPosition.y>0.1)//只显示前半部分的上半身

				outUV = inUV;
				varyType=vec3(type[0],type[1],type[2]);
				varyColor=vec3(color[0],color[1],color[2]);
				myTest00=type[3];

				if(vPosition.y<0.15)type_part=0.0;//下身
				else if(vPosition.y<0.59) type_part=1.0;//上身
				else type_part=2.0;//头部

				//开始求25个骨骼的变换矩阵
				//int time=10;
				mat4 matrixs0[25];
				//int iii;
				//int array[];
				//array=[];
				/*for(int iii=0;iii<25;iii++)//25个骨头
				{
					matrixs0[iii]=getMatrixs0_i(iii);
				}*/
				//0 1 2 3
				matrixs0[0]=getMatrixs0_i(0);
				matrixs0[1]=getMatrixs0_i(1);
				matrixs0[2]=getMatrixs0_i(2);
				matrixs0[3]=getMatrixs0_i(3);

				//7 8 9 10
				matrixs0[7]=getMatrixs0_i(7);
				matrixs0[8]=getMatrixs0_i(8);
				matrixs0[9]=getMatrixs0_i(9);
				matrixs0[10]=getMatrixs0_i(10);

				//11 12 13 14
				matrixs0[11]=getMatrixs0_i(11);
				matrixs0[12]=getMatrixs0_i(12);
				matrixs0[13]=getMatrixs0_i(13);
				matrixs0[14]=getMatrixs0_i(14);

            	mat4 matrixs[25];//25个骨骼//逆骨骼矩阵
				for(int i=0;i<25;i++){
						matrixs[i]=mat4(//最后一列是：0 0 0 1
				    	    skeletonMatrixInverse[i*16+0] ,skeletonMatrixInverse[i*16+1] ,skeletonMatrixInverse[i*16+2] ,skeletonMatrixInverse[i*16+3] ,
				  	      	skeletonMatrixInverse[i*16+4] ,skeletonMatrixInverse[i*16+5] ,skeletonMatrixInverse[i*16+6] ,skeletonMatrixInverse[i*16+7] ,
				    	    skeletonMatrixInverse[i*16+8] ,skeletonMatrixInverse[i*16+9] ,skeletonMatrixInverse[i*16+10],skeletonMatrixInverse[i*16+11],
				    	    skeletonMatrixInverse[i*16+12],skeletonMatrixInverse[i*16+13],skeletonMatrixInverse[i*16+14],skeletonMatrixInverse[i*16+15]
			    	    );
				}
						matrixs[3]=getMatrixs_i(3);
						matrixs[4]=getMatrixs_i(4);
						matrixs[5]=getMatrixs_i(5);
						matrixs[6]=getMatrixs_i(6);

						                           mat4 tool=matrixs0[0];
			    	    matrixs[0]=tool*matrixs[0];tool=tool*matrixs0[1];
			    	    matrixs[1]=tool*matrixs[1];tool=tool*matrixs0[2];
			    	    matrixs[2]=tool*matrixs[2];tool=tool*matrixs0[3];  mat4  _tool3=tool;
			    	    /*matrixs[3]=tool*matrixs[3];tool=tool*matrixs0[4];
			    	    matrixs[4]=tool*matrixs[4];tool=tool*matrixs0[5];
			    	    matrixs[5]=tool*matrixs[5];tool=tool*matrixs0[6];
			    	    matrixs[6]=tool*matrixs[6];*/

						                           tool=_tool3;
			    	                               tool=tool*matrixs0[7];
			    	    matrixs[7]=tool*matrixs[7];tool=tool*matrixs0[8];
			    	    matrixs[8]=tool*matrixs[8];tool=tool*matrixs0[9];
			    	    matrixs[9]=tool*matrixs[9];tool=tool*matrixs0[10];
			    	    matrixs[10]=tool*matrixs[10];

			    	                                 tool=_tool3;
			    	                                 tool=tool*matrixs0[11];
			    	    matrixs[11]=tool*matrixs[11];tool=tool*matrixs0[12];
			    	    matrixs[12]=tool*matrixs[12];tool=tool*matrixs0[13];
			    	    matrixs[13]=tool*matrixs[13];tool=tool*matrixs0[14];
			    	    matrixs[14]=tool*matrixs[14];

						matrixs[15]=getMatrixs_i(15);
						matrixs[16]=getMatrixs_i(16);
						matrixs[17]=getMatrixs_i(17);
						matrixs[18]=getMatrixs_i(18);
						matrixs[19]=getMatrixs_i(19);
						matrixs[20]=getMatrixs_i(20);
						matrixs[21]=getMatrixs_i(21);
						matrixs[22]=getMatrixs_i(22);
						matrixs[23]=getMatrixs_i(23);
						matrixs[24]=getMatrixs_i(24);

			    	                                 /*tool=matrixs0[0]*matrixs0[15];
			    	    matrixs[15]=tool*matrixs[15];tool=tool*matrixs0[16];
			    	    matrixs[16]=tool*matrixs[16];tool=tool*matrixs0[17];
			    	    matrixs[17]=tool*matrixs[17];tool=tool*matrixs0[18];
			    	    matrixs[18]=tool*matrixs[18];tool=tool*matrixs0[19];
			    	    matrixs[19]=tool*matrixs[19];

			    	                                 tool=matrixs0[0]*matrixs0[20];
			    	    matrixs[20]=tool*matrixs[20];tool=tool*matrixs0[21];
			    	    matrixs[21]=tool*matrixs[21];tool=tool*matrixs0[22];
			    	    matrixs[22]=tool*matrixs[22];tool=tool*matrixs0[23];
			    	    matrixs[23]=tool*matrixs[23];tool=tool*matrixs0[24];
			    	    matrixs[24]=tool*matrixs[24];*/

			    	    /*for(int i=0;i<25;i++)
			    	    matrixs[i]=getMatrixs_i(i);*/



            	int mySkinIndex[4];//求skinIndex的近似整数，结果存入mySkinIndex
            	for(int j=0;j<4;j++){
                	float i0=0.0;
                	for(int i=0;i<25;i++){
                   	if((skinIndex[j]-i0)>-0.5&&(skinIndex[j]-i0)<0.5){
                        	    mySkinIndex[j]=i;
                   	}
                   	i0=i0+1.0;
                	}
            	}

            	//计算动画的变换矩阵：matrix1=skinWeight[0]*matrixs[mySkinIndex[0]]+...
            	mat4 matrix1=mat4(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);
            	mat4 matrix_temp;
            	for(int i=0;i<25;i++)
	                if(i==mySkinIndex[0]){
    	                matrix_temp=matrixs[i];
        	            matrix1=matrix1+skinWeight[0]*matrix_temp;
            	    }else if(i==mySkinIndex[1]){
                	    matrix_temp=matrixs[i];
                    	matrix1=matrix1+skinWeight[1]*matrix_temp;
	                }else if(i==mySkinIndex[2]){
    	                matrix_temp=matrixs[i];
        	            matrix1=matrix1+skinWeight[2]*matrix_temp;
            	    }else if(i==mySkinIndex[3]){
                	    matrix_temp=matrixs[i];
                    	matrix1=matrix1+skinWeight[3]*matrix_temp;
         	        }



				mat4 matrix2 = mat4(//确定位置//最后一列是 0 0 0 1
					vec4( mcol0, 0),
					vec4( mcol1, 0),
					vec4( mcol2, 0),
					vec4( mcol3, 1)
				);

				gl_Position = projectionMatrix * modelViewMatrix*  matrix2  * matrix1 * vec4( position, 1.0 );

		}
	</script>
	<script id="fragmentShader" type="x-shader/x-fragment">
        precision highp float;
        uniform sampler2D text0;
        uniform sampler2D text1;
        uniform sampler2D text2;
        uniform sampler2D text3;
        uniform sampler2D text4;
        uniform sampler2D text5;
        uniform sampler2D text6;
        uniform sampler2D text7;
        uniform sampler2D text8;
        uniform sampler2D text9;
        uniform sampler2D text10;
        uniform sampler2D text11;
        uniform sampler2D text12;
        uniform sampler2D text13;
        uniform sampler2D text14;
        uniform sampler2D text15;

        varying float type_part;

        varying vec3 varyType;
        varying vec3 varyColor;
		varying vec2 outUV;

		varying float myTest00;

		void main(){
			vec4 myTexture;
			float type;

            if(floor(type_part)==0.0)type=varyType[0];//下身
            else if(floor(type_part)==1.0)type=varyType[1];
            else if(floor(type_part)==2.0)type=varyType[2];

               if (type>-0.1&&type<0.1)myTexture =texture2D(text0, outUV);
			else if(type>0.9&&type<1.1)myTexture =texture2D(text1, outUV);
			else if(type>1.9&&type<2.1)myTexture =texture2D(text2, outUV);
			else if(type>2.9&&type<3.1)myTexture =texture2D(text3, outUV);
			else if(type>3.9&&type<4.1)myTexture =texture2D(text4, outUV);
			else if(type>4.9&&type<5.1)myTexture =texture2D(text5, outUV);
			else if(type>5.9&&type<6.1)myTexture =texture2D(text6, outUV);
			else if(type>6.9&&type<7.1)myTexture =texture2D(text7, outUV);
			else if(type>7.9&&type<8.1)myTexture =texture2D(text8, outUV);
			else if(type>8.9&&type<9.1)myTexture =texture2D(text9, outUV);
			else if(type>9.9&&type<10.1)myTexture =texture2D(text10, outUV);
			else if(type>10.9&&type<11.1)myTexture =texture2D(text11, outUV);
			else if(type>11.9&&type<12.1)myTexture =texture2D(text12, outUV);
			else if(type>12.9&&type<13.1)myTexture =texture2D(text13, outUV);
			else if(type>13.9&&type<14.1)myTexture =texture2D(text14, outUV);
			else myTexture =texture2D(text15, outUV);

            float mytest0=varyType[1]*0.01;
            if(floor(type_part)==0.0){//下身
            	gl_FragColor = vec4 (
            					 myTexture.r+varyColor[0],
            					 myTexture.g+varyColor[1],
            					 myTexture.b+varyColor[2],
            					 1.0);
            }else if(floor(type_part)==1.0){//上身
            	gl_FragColor = vec4 (
            					 myTexture.r,
            					 myTexture.g,
            					 myTexture.b,
            					 1.0);
            }else if(floor(type_part)==2.0){//头部
            	gl_FragColor = vec4 (
            					 myTexture.r,
            					 myTexture.g,
            					 myTexture.b,
            					 1.0);
            }
		}
</script>
	<!--无骨骼动画的着色器-->
	<script id="vertexShader0" type="x-shader/x-vertex">//
		precision highp float;
		uniform mat4 modelViewMatrix;
		uniform mat4 projectionMatrix;


		attribute vec3 position;
		attribute vec2 inUV;

        attribute float random;

		attribute vec3 mcol0;
		attribute vec3 mcol1;
		attribute vec3 mcol2;
		attribute vec3 mcol3;

		attribute vec4 type;   //type[3]是0或1，用于表示动画
		attribute vec3 color;

        varying vec2 outUV;
        varying vec3 varyType;
        varying vec3 varyColor;
        varying float type_part;
        varying float myTest00;

		void main(){
			vec3 vPosition = position;
			//if(random<0.8)//显示百分之80三角面
			//if(vPosition.y<1.8)//全身显示
			//if(vPosition.y>0.61&&vPosition.x>0.0)//只显示脸

			if(true)//全身显示
			//if(vPosition.x>-0.09)//前半部分
			//if((vPosition.x>-0.01&&vPosition.y>0.1)||vPosition.y>0.65)//只显示前半部分的上半身和头
			//if(vPosition.x>-0.01&&vPosition.y>0.1)//只显示前半部分的上半身
			{
				outUV = inUV;
				varyType=vec3(type[0],type[1],type[2]);
				varyColor=vec3(color[0],color[1],color[2]);
				myTest00=type[3];

				if(position.z<-0.95)type_part=2.0;//头部
				else if(position.z<-0.60) type_part=1.0;//上身
				else type_part=0.0;//下身

				//if(position.z<-1.0)type_part=0.0;
				//else type_part=1.0;

				mat4 matrix2 = mat4(//确定位置//最后一列是 0 0 0 1
					vec4( mcol0, 0),
					vec4( mcol1, 0),
					vec4( mcol2, 0),
					vec4( mcol3, 1)
				);

				gl_Position = projectionMatrix * modelViewMatrix*  matrix2  *  vec4( position, 1.0 );
				//gl_Position = projectionMatrix * modelViewMatrix*  matrix2  * matrix1 * vec4( position, 1.0 );
			}
		}
	</script>
	<script id="fragmentShader0" type="x-shader/x-fragment">
        precision highp float;
        uniform sampler2D text0;
        uniform sampler2D text1;
        uniform sampler2D text2;
        uniform sampler2D text3;
        uniform sampler2D text4;
        uniform sampler2D text5;
        uniform sampler2D text6;
        uniform sampler2D text7;
        uniform sampler2D text8;
        uniform sampler2D text9;
        uniform sampler2D text10;
        uniform sampler2D text11;
        uniform sampler2D text12;
        uniform sampler2D text13;
        uniform sampler2D text14;
        uniform sampler2D text15;

        varying float type_part;

        varying vec3 varyType;
        varying vec3 varyColor;
		varying vec2 outUV;

		varying float myTest00;

		void main(){
			vec4 myTexture;
			float type;

            if(floor(type_part)==0.0)type=varyType[0];//下身
            else if(floor(type_part)==1.0)type=varyType[1];
            else if(floor(type_part)==2.0)type=varyType[2];

               if (type>-0.1&&type<0.1)myTexture =texture2D(text0, outUV);
			else if(type>0.9&&type<1.1)myTexture =texture2D(text1, outUV);
			else if(type>1.9&&type<2.1)myTexture =texture2D(text2, outUV);
			else if(type>2.9&&type<3.1)myTexture =texture2D(text3, outUV);
			else if(type>3.9&&type<4.1)myTexture =texture2D(text4, outUV);
			else if(type>4.9&&type<5.1)myTexture =texture2D(text5, outUV);
			else if(type>5.9&&type<6.1)myTexture =texture2D(text6, outUV);
			else if(type>6.9&&type<7.1)myTexture =texture2D(text7, outUV);
			else if(type>7.9&&type<8.1)myTexture =texture2D(text8, outUV);
			else if(type>8.9&&type<9.1)myTexture =texture2D(text9, outUV);
			else if(type>9.9&&type<10.1)myTexture =texture2D(text10, outUV);
			else if(type>10.9&&type<11.1)myTexture =texture2D(text11, outUV);
			else if(type>11.9&&type<12.1)myTexture =texture2D(text12, outUV);
			else if(type>12.9&&type<13.1)myTexture =texture2D(text13, outUV);
			else if(type>13.9&&type<14.1)myTexture =texture2D(text14, outUV);
			else myTexture =texture2D(text15, outUV);

            float mytest0=varyType[1]*0.01;

            /**/if(floor(type_part)==0.0){//下身
            	gl_FragColor = vec4 (
            					 myTexture.r+varyColor[0],
            					 myTexture.g+varyColor[1],
            					 myTexture.b+varyColor[2],
            					 1.0);
            }else if(floor(type_part)==1.0){//上身
            	gl_FragColor = vec4 (
            					 myTexture.r,
            					 myTexture.g,
            					 myTexture.b,
            					 1.0);
            }else if(floor(type_part)==2.0){//头部
            	gl_FragColor = vec4 (
            					 myTexture.r,
            					 myTexture.g,
            					 myTexture.b,
            					 1.0);
            }
            //gl_FragColor =vec4 (0.0,type_part,myTest00,1.0);//myTest00值为0

            /*if(floor(type_part)==2.0)
            			gl_FragColor = vec4 (
            					 myTexture.r+0.5,
            					 myTexture.g,
            					 myTexture.b,
            					 1.0);*/
		}
</script>

		<script src="lib/threeJS/three.js"></script>
		<script src="lib/threeJS/OrbitControls.js"></script>
		<script src="lib/threeJS/GLTFLoader.js"></script>

		<script src="lib/pmLib/PMAnimLoader.js"></script>
		<script src="lib/pmLib/MyPMLoader.js"></script>

		<script src="js/sceneSet/RoomManager.js"></script>
		<script src="js/sceneSet/SeatManager.js"></script>
		<script src="js/sceneSet/AvatarManager.js"></script>

		<script src="js/playerControl/PlayerControl.js"></script>
		<script src="js/playerControl/PreviewManager.js"></script>

		<script src="js/InstancedGroup.js"></script>
		<script src="js/ParamMeasure.js"></script>
		<script src="js/Main.js"></script>

		<script src="test/testLaunch.js"></script>
	</body>
</html>
