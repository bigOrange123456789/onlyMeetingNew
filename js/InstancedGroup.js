function InstancedGroup(instanceCount,originMesh,animationClip ){
    //若有骨骼，则需要源mesh是skinnedMesh
    this.obj=new THREE.Object3D();
    this.instanceCount=instanceCount;

    if(typeof(animationClip)=="undefined"||animationClip===false)this.haveSkeleton=flase;
    else this.haveSkeleton=true;
    this.originMeshs=originMesh;//这是一个数组，每个元素播放一种动画
    this.animationClip=animationClip;
    this.mesh=null;//实例化渲染对象的网格

    this.speed;
    this.mcol0;//变换矩阵的一部分
    this.mcol1;
    this.mcol2;
    this.mcol3;
    this.scales=[];
    this.rotations=[];
    this.type;
    this.colors;

    this.time=0;//每帧自动加1，加到一定值之后自动归0

    this.dummy=new THREE.Object3D();//dummy仿制品//工具对象

    this.init=function (texSrc){
        for(var i=0;i<this.instanceCount;i++){
            this.scales.push([1,1,1]);
            this.rotations.push([0,0,0]);
        }
        //const instanceCount =2*2;//10 0000//1089
        let texs_length=16;

        this.originMeshs[0].geometry=this.originMeshs[0].geometry.toNonIndexed();

        var geometry = new THREE.InstancedBufferGeometry();//console.log(geometry);
        geometry.instanceCount = this.instanceCount; // set so its initalized for dat.GUI, will be set in first draw otherwise
        //以下是使用geometry设置setAttribute(BufferAttribute/InstancedBufferAttribute)
        //BufferAttribute为每个点分配一组数据:先准备数据再生成空间
        //1-2
        geometry.setAttribute('position', this.originMeshs[0].geometry.attributes.position);//Float32Array
        geometry.setAttribute('inUV',this.originMeshs[0].geometry.attributes.uv);
        //3
        var randoms=new Float32Array(this.originMeshs[0].geometry.attributes.position.count);
        for(i=0;i<randoms.length;i++)
            randoms[i]=Math.random();
        geometry.setAttribute('random',new THREE.BufferAttribute(randoms,1));
        //4-5
        if(this.haveSkeleton){
            geometry.setAttribute('skinIndex',this.originMeshs[0].geometry.attributes.skinIndex);
            geometry.setAttribute('skinWeight',this.originMeshs[0].geometry.attributes.skinWeight);
        }
        //InstancedBufferAttribute为每个对象一组数据：先生成空间，再设置数据
        //6-11
        this.speed=new THREE.InstancedBufferAttribute(new Float32Array(this.instanceCount * 1), 1);

        this.mcol0=new THREE.InstancedBufferAttribute(new Float32Array(this.instanceCount * 3), 3);
        this.mcol1=new THREE.InstancedBufferAttribute(new Float32Array(this.instanceCount * 3), 3);
        this.mcol2=new THREE.InstancedBufferAttribute(new Float32Array(this.instanceCount * 3), 3);
        this.mcol3=new THREE.InstancedBufferAttribute(new Float32Array(this.instanceCount * 3), 3);

        this.type=new THREE.InstancedBufferAttribute(new Uint16Array(this.instanceCount*4), 4);//头部、上衣、裤子、动作
        this.colors=new THREE.InstancedBufferAttribute(new Float32Array(this.instanceCount*3), 3);

        for(i=0;i<this.instanceCount;i++){
                this.speed.setX(i,i/20+0.01)//Math.random()*9+0.05);
                //this.speed.setX(i,Math.random()*9+0.05);
                this.mcol0.setXYZ(i, 1,0,0);//随机长宽高
                this.mcol1.setXYZ(i, 0,1,0);//四元数、齐次坐标
                this.mcol2.setXYZ(i, 0,0,1);//mcol3.setXYZ(i, 0,0,0);

                this.mcol3.setXYZ(i, 0,0,0);

                this.type.setXYZW(i,
                    Math.floor(Math.random() * texs_length),
                    Math.floor(Math.random() * texs_length),
                    Math.floor(Math.random() * texs_length),
                    Math.floor(Math.random() *2)//Math.random()//这个缓冲区是int类型的//所以这里不能传小数
                );
                this.colors.setXYZ(i,
                    0.0,0.0,0.0
                );
        }
        geometry.setAttribute('speed', this.speed);

        geometry.setAttribute('mcol0', this.mcol0);//四元数、齐次坐标
        geometry.setAttribute('mcol1', this.mcol1);
        geometry.setAttribute('mcol2', this.mcol2);
        geometry.setAttribute('mcol3', this.mcol3);

        geometry.setAttribute('type', this.type);
        geometry.setAttribute('color', this.colors);

        //以下是根据material设置的uniform
        let texs=[];
        for(i=0;i<texs_length;i++){
            texs.push( THREE.ImageUtils.loadTexture(texSrc[i]) ) ;
            texs[i].flipY=false;
            texs[i].wrapS = texs[i].wrapT = THREE.ClampToEdgeWrapping;
        }

        let material;
        if(this.haveSkeleton){

            var skeletonDataArray=[];//10*25*36//400
            //console.log(this.originMeshs);
            for (j = 0; j < 8; j++)//8个时间点
                for (i = 0; i < this.originMeshs[0].skeleton.boneInverses.length*3; i+=3)//8*3
                    if(
                        i===7*3||
                        i===8*3||
                        i===9*3||
                        i===10*3||

                        i===11*3||
                        i===12*3||
                        i===13*3||
                        i===14*3
                    )/**/
                {//这个36是时间数
                    //for(k=0;k<10;k++)
                    //position
                    skeletonDataArray.push(this.animationClip.tracks[i].values[3*j]);
                    skeletonDataArray.push(this.animationClip.tracks[i].values[3*j+1]);
                    skeletonDataArray.push(this.animationClip.tracks[i].values[3*j+2]);
                    //quaternion
                    skeletonDataArray.push(this.animationClip.tracks[i+1].values[4*j]);
                    skeletonDataArray.push(this.animationClip.tracks[i+1].values[4*j+1]);
                    skeletonDataArray.push(this.animationClip.tracks[i+1].values[4*j+2]);
                    skeletonDataArray.push(this.animationClip.tracks[i+1].values[4*j+3]);
                    //scale
                    skeletonDataArray.push(this.animationClip.tracks[i+2].values[3*j]);
                    skeletonDataArray.push(this.animationClip.tracks[i+2].values[3*j+1]);
                    skeletonDataArray.push(this.animationClip.tracks[i+2].values[3*j+2]);
                    //console.log(i,j)
                }
            //console.log(skeletonDataArray.length)//2880=36*8*10
            material = new THREE.RawShaderMaterial({//原始着色器材质
                uniforms: {
                    text0: {type: 't', value: texs[0]}//textureHandle
                    ,text1: {type: 't', value: texs[1]}
                    ,text2: {type: 't', value: texs[2]}
                    ,text3: {type: 't', value: texs[3]}
                    ,text4: {type: 't', value: texs[4]}
                    ,text5: {type: 't', value: texs[5]}
                    ,text6: {type: 't', value: texs[6]}
                    ,text7: {type: 't', value: texs[7]}
                    ,text8: {type: 't', value: texs[8]}
                    ,text9: {type: 't', value: texs[9]}
                    ,text10: {type: 't', value: texs[10]}//textureHandle
                    ,text11: {type: 't', value: texs[11]}
                    ,text12: {type: 't', value: texs[12]}
                    ,text13: {type: 't', value: texs[13]}
                    ,text14: {type: 't', value: texs[14]}
                    ,text15: {type: 't', value: texs[15]}

                    ,skeletonMatrixInverse:{value: []}
                    ,skeletonMatrix:{value: []}////骨骼25*16=400//骨骼矩阵//用于求不动位置的骨骼

                    ,skeletonData:{value: [
                            6.187614198990661,
                            94.85781043204769,
                            31.04375654069344,
                            6.286445418472553,
                            30.671196613947536,
                            -94.97242893520915,
                            -99.61022889354516,
                            7.828089935366042,
                            -4.065407379514824,
                            -2.3006444513812223,
                            -55.81837703033168,
                            -39.302185840350226,
                            -57.60065690059174,
                            76.61206781543892,
                            -28.508974581589975,
                            57.70607873011864,
                            13.40734849453288,
                            -80.56210242031219,
                            -57.89799661295266,
                            -62.855716248896584,
                            -51.93254786408669,
                            -24.204016615211238,
                            -57.57260300196859,
                            -55.01120439332353,
                            1.2552004446817415,
                            -27.21948488285497,
                            -96.21605009716383,
                            96.91296301667143,
                            -23.36420941808992,
                            7.874048236579142,
                            -24.623389309601905,
                            -93.34463750081218,
                            26.08589817822228,
                            -23.6417186202804,
                            -59.961644571431584,
                            -61.416829234842524,
                            1.2551991770233109,
                            -27.219484559158516,
                            -96.2160506711082,
                            96.91296655900203,
                            -23.364216634117177,
                            7.874051245106461,
                            -24.623382504833124,
                            -93.34464689282153,
                            26.085901056086673,
                            -23.64171276116602,
                            -59.96164770561599,
                            -61.416828101980585,
                            -10.56613686978628,
                            94.5151954686116,
                            30.906898146858126,
                            1.9610022844431718,
                            31.27289622694558,
                            -94.96405153282026,
                            -99.42091936222543,
                            -9.427947825516808,
                            -5.157758387904945,
                            -0.462845552415049,
                            -56.692662147534904,
                            -39.457180631456595,
                            47.84985831041387,
                            83.48888311332851,
                            -27.2029617519698,
                            -53.037092097749294,
                            2.789504884055482,
                            -84.73068013874388,
                            -69.98183640049139,
                            54.97112628857072,
                            45.61485916502842,
                            24.876558985522053,
                            -51.708040707870545,
                            -53.48582351901744,
                            14.720548879193661,
                            -19.951909135007188,
                            -96.8774455662211,
                            -91.81039601632807,
                            -39.19571027042463,
                            -5.8782502987165905,
                            -36.79889979718007,
                            89.80880501081667,
                            -24.087755775660234,
                            25.30285156677777,
                            -53.81970786742822,
                            -59.57225724640013,
                            14.720549386919787,
                            -19.951909900929138,
                            -96.87744415602877,
                            -91.81040867921745,
                            -39.19570177386595,
                            -5.878252853666185,
                            -36.798908162806924,
                            89.80880334197744,
                            -24.0877570617659,
                            25.302859705842934,
                            -53.81970410154432,
                            -59.5722723162082,
                            4.947916479298488,
                            95.01418566698406,
                            30.786847994510154,
                            6.489018643416468,
                            30.45367057950616,
                            -95.02877449659857,
                            -99.66650839770568,
                            6.699726786425826,
                            -4.658701705682052,
                            -2.3430430759627505,
                            -55.79039937299257,
                            -39.27154218083429,
                            -52.73423957208571,
                            80.0301616123023,
                            -28.535637500771177,
                            59.315013722556664,
                            10.629268539246603,
                            -79.80441321649198,
                            -60.834441852994175,
                            -59.01018768327745,
                            -53.0751829104695,
                            -25.1853799392353,
                            -55.4600754177538,
                            -55.461780702020405,
                            0.5217016040320788,
                            -26.11567504380918,
                            -96.52827322530244,
                            95.30143224919802,
                            -29.10756365258036,
                            8.390132211837015,
                            -30.28808493216072,
                            -92.0365966592625,
                            24.73670390466479,
                            -24.700712615493586,
                            -57.806249875865795,
                            -61.86805665386495,
                            0.5217021914912428,
                            -26.115674775572415,
                            -96.52827982091068,
                            95.30143103668013,
                            -29.107574311420592,
                            8.39013529416027,
                            -30.28807638917484,
                            -92.03660469679917,
                            24.73670524255018,
                            -24.70070457641923,
                            -57.806254172189256,
                            -61.86806376172594,
                            -10.911071010000803,
                            94.5777739321423,
                            30.594054872302856,
                            2.0792900206682567,
                            30.98824377571234,
                            -95.05475078465439,
                            -99.38120783295085,
                            -9.73535009572911,
                            -5.347674751112333,
                            -0.42558891015859457,
                            -56.598820034525524,
                            -39.448544118165444,
                            37.94202249812395,
                            88.4808092128119,
                            -27.047089926618742,
                            -53.65119639396734,
                            -2.775891779600988,
                            -84.34355609763682,
                            -75.37865109038577,
                            46.512774341810776,
                            46.41780423183157,
                            25.76318955465504,
                            -47.6579497199752,
                            -53.84386399516782,
                            16.150051832608522,
                            -17.661186305747414,
                            -97.09404378998842,
                            -86.85395710045515,
                            -49.257250379063095,
                            -5.487004200130933,
                            -46.85677067520912,
                            85.21621931585665,
                            -23.294507243650294,
                            26.378806994527874,
                            -49.67655489925296,
                            -59.944635095127865,
                            16.150051598544252,
                            -17.661187193326764,
                            -97.09404251301987,
                            -86.85397145065102,
                            -49.25724762651937,
                            -5.48700467814613,
                            -46.85677839724359,
                            85.21622053739893,
                            -23.294509324109104,
                            26.378810248430973,
                            -49.67654976664115,
                            -59.94462726822174,
                            3.709050503464357,
                            95.15830308596128,
                            30.51460555427614,
                            6.691462661057759,
                            30.23059951703344,
                            -95.08594762804863,
                            -99.70690251963282,
                            5.568667252971358,
                            -5.246228446318447,
                            -2.3850047489124364,
                            -55.75953301334698,
                            -39.239735431057134,
                            -47.68285197053055,
                            83.16719299188325,
                            -28.45286420954121,
                            60.75654173805094,
                            7.7917935251514265,
                            -79.04386377122515,
                            -63.52156213932617,
                            -54.97735283011189,
                            -54.24487286641995,
                            -26.0438193924805,
                            -53.298492528656354,
                            -55.91409350479266,
                            -0.1076712997734095,
                            -24.91594576596595,
                            -96.84618723176187,
                            93.35369264126321,
                            -34.742508341817214,
                            8.834551051303317,
                            -35.848000735902076,
                            -90.39998744789285,
                            23.2973487039536,
                            -25.632172063184292,
                            -55.594361649522625,
                            -62.32216125752427,
                            -0.10767147815909262,
                            -24.915947311306624,
                            -96.84619333877289,
                            93.35369070313999,
                            -34.742519163097704,
                            8.834553941203401,
                            -35.84799288492221,
                            -90.39999539291506,
                            23.297352022044855,
                            -25.63216465780527,
                            -55.594363834922255,
                            -62.322159989438134,
                            -11.254233349166975,
                            94.63919272812495,
                            30.27814498117678,
                            2.198447853324094,
                            30.701452165864936,
                            -95.1451116089672,
                            -99.34037002135501,
                            -10.042212342570238,
                            -5.535765915095407,
                            -0.3884506828226604,
                            -56.5037793938866,
                            -39.439117379292156,
                            27.52929558605981,
                            92.31560084213635,
                            -26.832162265686975,
                            -53.661646141152474,
                            -8.402124484490194,
                            -83.96324515919486,
                            -79.76564610011599,
                            37.51306636766555,
                            47.22504388546519,
                            26.188765194123278,
                            -43.535241997460204,
                            -54.19599727136581,
                            17.27413876814653,
                            -15.25309298189862,
                            -97.30850236874035,
                            -80.79657526058112,
                            -58.698112944196886,
                            -5.142020655433352,
                            -56.33391351516776,
                            79.5101908199264,
                            -22.463583209996386,
                            26.979609017262323,
                            -45.44190777856714,
                            -60.31156809765082,
                            17.274140810848962,
                            -15.253093431061425,
                            -97.30850088181325,
                            -80.7965984709551,
                            -58.69811067469766,
                            -5.142023209080604,
                            -56.333928932641186,
                            79.510192321562,
                            -22.463586201439178,
                            26.979621809886055,
                            -45.441903214681936,
                            -60.31156679627107,
                            3.5636484188096493,
                            95.27006453139508,
                            30.18151997139561,
                            6.881688418821799,
                            29.89509105910656,
                            -95.17843698064429,
                            -99.69927986228086,
                            5.468832994162015,
                            -5.490868213003672,
                            -2.4535502873392625,
                            -55.61342527931847,
                            -39.221362254707586,
                            -42.496991179683384,
                            85.94446286538414,
                            -28.41765041171987,
                            63.07117126513268,
                            5.594483313664053,
                            -77.39982429594394,
                            -64.9310139564415,
                            -50.8159416814171,
                            -56.58368824323504,
                            -27.230043823516272,
                            -51.53760889343903,
                            -57.055487413107464,
                            1.0079677834431315,
                            -23.535858713795047,
                            -97.18569828852254,
                            91.13954641212825,
                            -39.77088981318297,
                            10.576767203115168,
                            -41.140890149548866,
                            -88.6811808080221,
                            21.049561131185026,
                            -26.778762668070186,
                            -53.76411770246477,
                            -63.48214453118946,
                            1.0079680871521433,
                            -23.535860938438137,
                            -97.18570427596664,
                            91.13954855710463,
                            -39.770897582485276,
                            10.576770718338992,
                            -41.14088528269343,
                            -88.68119104554204,
                            21.049564779235794,
                            -26.778757950651734,
                            -53.76412193698913,
                            -63.48214313656546,
                            -11.267095345769953,
                            94.72847105509413,
                            29.992848600409477,
                            1.890961658517572,
                            30.384028517477475,
                            -95.25356094923971,
                            -99.34524912986748,
                            -10.165163127436065,
                            -5.214643165321473,
                            -0.18144616708602657,
                            -56.38860092186633,
                            -39.42671032181251,
                            19.450970970050438,
                            93.99736511063752,
                            -28.038450350905336,
                            -55.35682683552696,
                            -13.078390494348017,
                            -82.2470360338165,
                            -80.97702300402042,
                            31.519040106159565,
                            49.49007109160913,
                            27.025485246735403,
                            -40.34861827109994,
                            -55.40465226993469,
                            15.531248369516536,
                            -14.076692902243645,
                            -97.77845109990271,
                            -76.0582462033526,
                            -64.86617109652477,
                            -2.742708976247335,
                            -63.039051572183986,
                            74.794554034899,
                            -20.781033298744376,
                            27.77799887894144,
                            -42.205968527861344,
                            -61.52179992827304,
                            15.53124844961011,
                            -14.076694174751117,
                            -97.77844973951402,
                            -76.05826082959446,
                            -64.86616693242857,
                            -2.742709792043928,
                            -63.039059400498,
                            74.79454967339922,
                            -20.781034341814305,
                            27.778001953497995,
                            -42.20596113492687,
                            -61.521800230373856,
                            3.4185195954596916,
                            95.38022957521322,
                            29.848386364538655,
                            7.073889708278141,
                            29.559989744827636,
                            -95.26895533691885,
                            -99.69088119074553,
                            5.368239145808243,
                            -5.736594578712758,
                            -2.522859413573615,
                            -55.467507041927256,
                            -39.20392004661909,
                            -37.17969117023934,
                            88.44150332244804,
                            -28.209347132521184,
                            65.23885906615831,
                            3.274631871920377,
                            -75.71769966292914,
                            -66.04209099782246,
                            -46.55506658585554,
                            -58.91580534048122,
                            -28.2963120393266,
                            -49.708800689056474,
                            -58.209963970593385,
                            2.229039197504111,
                            -22.196793103702376,
                            -97.47998782622423,
                            88.62364271237777,
                            -44.68735772072861,
                            12.20212253398184,
                            -46.2696620118557,
                            -86.6622345162788,
                            18.675468455031883,
                            -27.799656554876027,
                            -51.86688230339839,
                            -64.65339493804049,
                            2.229039059254749,
                            -22.19679325634187,
                            -97.47999425712885,
                            88.62364096185276,
                            -44.687365796266874,
                            12.20212374867682,
                            -46.269652432702806,
                            -86.6622449590682,
                            18.67547125651939,
                            -27.799649729423564,
                            -51.86688502761102,
                            -64.65339406806922,
                            -11.27955624941595,
                            94.8172167073268,
                            29.70633845805764,
                            1.5854079096516038,
                            30.065055254661015,
                            -95.36032170087029,
                            -99.3491751653964,
                            -10.285249292338289,
                            -4.894429688239352,
                            0.024838587866966133,
                            -56.272629912666545,
                            -39.41497631804581,
                            11.236888148712627,
                            95.04365771602419,
                            -28.990270805789493,
                            -56.652895813373334,
                            -17.84080074171991,
                            -80.44975404268871,
                            -81.63442338444665,
                            25.46386744285253,
                            51.84026130485875,
                            27.579326704032873,
                            -37.128415870332304,
                            -56.65853521499077,
                            13.628538925482609,
                            -13.022523079084628,
                            -98.20740687941635,
                            -70.79839440832279,
                            -70.62136873149764,
                            -0.46036719697533757,
                            -69.29538527136711,
                            69.59194872811233,
                            -18.84441271844885,
                            28.286704907183974,
                            -38.938581348036216,
                            -62.776818285786895,
                            13.628539019560339,
                            -13.02252405941062,
                            -98.20740559499957,
                            -70.7984094939107,
                            -70.6213693768079,
                            -0.460366772322903,
                            -69.29539263055482,
                            69.5919483622617,
                            -18.844414304652716,
                            28.286709617428205,
                            -38.9385767956599,
                            -62.776825826392795,
                            3.6602855256565383,
                            95.36044392623909,
                            29.882842823542102,
                            6.693120443278161,
                            29.60180127583338,
                            -95.28342715249653,
                            -99.70860047292861,
                            5.487745237365892,
                            -5.2990917523166345,
                            -2.3594512673174526,
                            -55.439216783341884,
                            -39.19961024930315,
                            -44.21200572666991,
                            85.10600900721852,
                            -28.324163085696988,
                            63.67003118842095,
                            7.535589245202164,
                            -76.74200815597635,
                            -63.17771595214289,
                            -51.963207504753655,
                            -57.51867949990128,
                            -27.337335261325208,
                            -52.68107145973864,
                            -57.56566179241334,
                            2.8048821015451466,
                            -23.518918090305903,
                            -97.15445009885742,
                            91.92307893560627,
                            -37.577570820022245,
                            11.750544695110523,
                            -39.27190665054623,
                            -89.63694614420976,
                            20.56527781772551,
                            -26.757310421993758,
                            -54.89090196025601,
                            -64.01680393854372,
                            2.804883682624512,
                            -23.51892537799642,
                            -97.15446704323999,
                            91.92308912419611,
                            -37.57758177315604,
                            11.750550183595184,
                            -39.2719000435618,
                            -89.63696606558821,
                            20.56528656837306,
                            -26.757305259064452,
                            -54.89091457822664,
                            -64.01680738591087,
                            -10.651622625066388,
                            94.84415724018577,
                            29.85169603798235,
                            1.3833819293927263,
                            30.160953065652038,
                            -95.3331092127669,
                            -99.42147488249475,
                            -9.741564336980339,
                            -4.524668003556826,
                            0.10353327838687543,
                            -56.29807245519283,
                            -39.423152415189236,
                            19.410841796675566,
                            93.75760214069622,
                            -28.85692037526183,
                            -57.07704259386553,
                            -13.130297394852633,
                            -81.05431471733421,
                            -79.78360907376108,
                            32.203997085596676,
                            50.965394869114434,
                            27.724120897761857,
                            -40.39174435388799,
                            -56.1733925524658,
                            13.530952376826688,
                            -14.283945588442656,
                            -98.04530577160116,
                            -76.42751020283852,
                            -64.47868345580264,
                            -1.153827568190236,
                            -63.05350586612905,
                            75.08968075614058,
                            -19.641445274553117,
                            28.34359164089451,
                            -42.26422492922778,
                            -62.286730541073865,
                            13.530952376764048,
                            -14.283945751543762,
                            -98.04529857393482,
                            -76.42752506326563,
                            -64.47867884061263,
                            -1.153827666415871,
                            -63.05351344559897,
                            75.08967667173815,
                            -19.64144616516367,
                            28.3435962102116,
                            -42.26421631878317,
                            -62.28672322843489,
                            3.901402407408112,
                            95.34113539284928,
                            29.913997137651403,
                            6.311474239919505,
                            29.6418991638712,
                            -95.29703184555547,
                            -99.72435289304079,
                            5.605949794884533,
                            -4.861002387168583,
                            -2.1958506929158137,
                            -55.41029957855661,
                            -39.195615806616885,
                            -50.975132366541565,
                            81.25204880872616,
                            -28.277923637626113,
                            61.76695693630882,
                            11.68435236302361,
                            -77.77092253123077,
                            -59.88638340383421,
                            -57.11024655907252,
                            -56.14305086518599,
                            -26.142499519714057,
                            -55.57499548535498,
                            -56.91728738326236,
                            3.5396755127096116,
                            -24.727851704250764,
                            -96.82977070155677,
                            94.6621463817192,
                            -30.233464772697495,
                            11.181310161330394,
                            -32.039871409417984,
                            -92.05690691429754,
                            22.337723595172978,
                            -25.47269430326501,
                            -57.82693629891824,
                            -63.37738896512395,
                            3.539676548484141,
                            -24.7278557842427,
                            -96.82977610995046,
                            94.66214413526868,
                            -30.23346926153457,
                            11.181312722512615,
                            -32.0398624695207,
                            -92.05691100336759,
                            22.33772801039928,
                            -25.47268595648396,
                            -57.826936973677704,
                            -63.37737911691842,
                            -10.02337089887234,
                            94.86882636088487,
                            29.990657471911796,
                            1.1810482285892832,
                            30.2537915785131,
                            -95.30643319592538,
                            -99.4893864494374,
                            -9.198711875319276,
                            -4.152875383638158,
                            0.18207102281976084,
                            -56.32226970593099,
                            -39.43099312651948,
                            27.444789254922604,
                            91.78442424921698,
                            -28.677561571310335,
                            -57.11116139721487,
                            -8.434954800059893,
                            -81.65271849829625,
                            -77.36339455847886,
                            38.787503723528914,
                            50.10421029491302,
                            27.588231420928295,
                            -43.6461892003328,
                            -55.691387669578134,
                            13.30733638937033,
                            -15.571818482440246,
                            -97.87972397936247,
                            -81.51893832523108,
                            -57.889160695004875,
                            -1.8733342492548966,
                            -56.36997663893575,
                            80.03978696472888,
                            -20.397483463082047,
                            28.113752647619116,
                            -45.57597580481506,
                            -61.799992728001996,
                            13.307338113412154,
                            -15.571822113782853,
                            -97.87973420123514,
                            -81.51896322879891,
                            -57.88916545504753,
                            -1.873334162829706,
                            -56.36999030187073,
                            80.03979740005566,
                            -20.39748841763436,
                            28.1137632580803,
                            -45.57597593765609,
                            -61.79999888220472,
                            3.8180195892979323,
                            95.25874258902336,
                            30.186067904375303,
                            6.049522990877843,
                            29.93234385217188,
                            -95.22321360758546,
                            -99.74382481244828,
                            5.461768966848112,
                            -4.6199061939853685,
                            -2.0336121798840336,
                            -55.50002319053236,
                            -39.207339534567794,
                            -58.01484826736163,
                            76.24037591868891,
                            -28.665046730522654,
                            59.718836369410205,
                            15.882333370307222,
                            -78.62197057421339,
                            -55.38902327353181,
                            -62.730855894522904,
                            -54.743992556960244,
                            -24.644026806717598,
                            -58.54724253973676,
                            -56.31862784604299,
                            5.2439940080712,
                            -26.456641504796526,
                            -96.29407512962153,
                            96.96945430851535,
                            -21.692776467385464,
                            11.240853405949006,
                            -23.862812349212916,
                            -93.9652816114903,
                            24.517248614301167,
                            -23.82198891055503,
                            -60.867896159134716,
                            -62.78229254976028,
                            5.243993845440371,
                            -26.456642556501215,
                            -96.29406912512252,
                            96.96945297806775,
                            -21.692777862305974,
                            11.24085681226666,
                            -23.86280014268314,
                            -93.96528551134847,
                            24.51725322299502,
                            -23.82197783083243,
                            -60.86790077491173,
                            -62.78228911355308,
                            -9.239397541621067,
                            94.85441865851548,
                            30.28652835963523,
                            1.8171877926300937,
                            30.572206232868048,
                            -95.19476205145163,
                            -99.55569958348548,
                            -8.245057746225987,
                            -4.548348185369669,
                            -0.11348368929295116,
                            -56.42049410400482,
                            -39.461302809991075,
                            36.22687626976828,
                            88.81339000824791,
                            -28.280591024736054,
                            -55.550033528608,
                            -3.791411049459864,
                            -83.06515039369857,
                            -74.84521834544942,
                            45.8017763833146,
                            47.96236728209752,
                            26.700606152730888,
                            -46.86607370680095,
                            -54.70439738268748,
                            14.412413059985234,
                            -17.05743197450659,
                            -97.47477168542105,
                            -86.25299345776644,
                            -50.448177049027194,
                            -3.9250934546344274,
                            -48.504693593474556,
                            84.64057291101884,
                            -21.983343214794736,
                            27.20889239136682,
                            -48.85948626561381,
                            -60.78481964637562,
                            14.412414953745715,
                            -17.057434296563862,
                            -97.47478207888825,
                            -86.25301843065404,
                            -50.44817994149796,
                            -3.9250948813649016,
                            -48.50470651668983,
                            84.64058458333982,
                            -21.983347385803874,
                            27.208904333768626,
                            -48.85948796838004,
                            -60.78481797166241
                        ]}//8个手臂骨骼的数据
                    ,time:{value: 0.0}
                },
                vertexShader: document.getElementById('vertexShader').textContent,
                fragmentShader: document.getElementById('fragmentShader').textContent,
                side: THREE.DoubleSide
            });
            material.uniforms.skeletonMatrix={
                "value": [
                    -4.512656269742088,
                    94.90223800285591,
                    -31.19623791336128,
                    0,
                    -0.2622063338033979,
                    -31.239212678767224,
                    -94.99498303115439,
                    0,
                    -99.89781611748916,
                    -4.204979818578449,
                    1.6585312826377945,
                    0,
                    -0.1975276938170811,
                    -33.44611032392678,
                    -39.80350961079591,
                    1,
                    -4.469140964898684,
                    96.70940414803171,
                    -25.046382325749903,
                    0,
                    3.02972174673861,
                    -24.928706679681948,
                    -96.79556685847082,
                    0,
                    -99.85415365304378,
                    -5.084747960105429,
                    -1.8159522060313575,
                    0,
                    -0.9858400190578435,
                    -34.940500799060565,
                    -39.31223045360107,
                    1,
                    -6.384493427509462,
                    99.77440919152875,
                    2.075981730628909,
                    0,
                    4.734888505044303,
                    2.3807227630560748,
                    -99.8594682057082,
                    0,
                    -99.68361704146815,
                    -6.27720820948049,
                    -4.87622886966853,
                    0,
                    -1.5816395312567055,
                    -43.96236126817509,
                    -37.87652720113182,
                    1,
                    -0.08232527792467115,
                    0.9695445128471971,
                    0.23066517585024673,
                    0,
                    0.06808313305834383,
                    0.23638136897045145,
                    -0.9692720964059699,
                    0,
                    -0.9942773891497295,
                    -0.06409101693255502,
                    -0.08547002754437744,
                    0,
                    0.6311891814649118,
                    -45.10707207933926,
                    -81.63964118111745,
                    1,
                    -7.842942139339913,
                    99.07484964548468,
                    11.075445476173247,
                    0,
                    4.870447317597244,
                    11.477184118357723,
                    -99.21971530355516,
                    0,
                    -99.57293761080403,
                    -7.2423041838739515,
                    -5.725562541008952,
                    0,
                    -1.4983216668511665,
                    -45.784222884849385,
                    -37.6275234200084,
                    1,
                    -5.470554119293823,
                    99.83944547550466,
                    1.4700241529281914,
                    0,
                    -1.340714257383935,
                    1.3986371152313497,
                    -99.98122127637563,
                    0,
                    -99.84126616261094,
                    -5.489218046352042,
                    1.2620213681904422,
                    0,
                    2.4492956377320905,
                    -39.45639994941337,
                    -37.39306551308175,
                    1,
                    -99.84127282146804,
                    -5.489232112519777,
                    1.2620379270395756,
                    0,
                    -1.3407315624959948,
                    1.3986526765644813,
                    -99.98123179594232,
                    0,
                    5.470567737299513,
                    -99.8394521319594,
                    -1.4700403875105241,
                    0,
                    1.178099687274675,
                    -40.87520215145449,
                    -37.395854120774814,
                    1,
                    4.51968734779436,
                    95.11868107892252,
                    30.528833369266817,
                    0,
                    7.734950226644472,
                    30.135101391937194,
                    -95.037068252859,
                    0,
                    -99.59792466562543,
                    6.656783793423788,
                    -5.995382939873338,
                    0,
                    -2.7166190034304645,
                    -55.66705354381221,
                    -39.263563418303924,
                    1,
                    -59.359076474489314,
                    75.42351759984973,
                    -28.06768886446824,
                    0,
                    58.609507579317004,
                    16.615095314724968,
                    -79.30236140984607,
                    0,
                    -55.14918295796651,
                    -63.52349413673964,
                    -54.06789997185103,
                    0,
                    -23.962906653320076,
                    -59.28050614488589,
                    -55.64200061825026,
                    1,
                    5.768521031479166,
                    -28.10049123629665,
                    -95.79709670339481,
                    0,
                    97.29486537644519,
                    -19.919522889943224,
                    11.701774127010129,
                    0,
                    -22.37058309309331,
                    -93.88066589035188,
                    26.191236300698336,
                    0,
                    -23.120975487415443,
                    -61.69146846244139,
                    -62.157909049660226,
                    1,
                    5.768518692332587,
                    -28.100492270267267,
                    -95.79710316492981,
                    0,
                    97.29486960804104,
                    -19.91952926251657,
                    11.70177438445155,
                    0,
                    -22.37057461333388,
                    -93.88067526906656,
                    26.19123987650485,
                    0,
                    -23.120969160517483,
                    -61.69147179600691,
                    -62.157907146936374,
                    1,
                    -8.961787451925824,
                    94.8531525284198,
                    30.37384094568698,
                    0,
                    3.920564015145203,
                    30.80888708072441,
                    -95.05498272070916,
                    0,
                    -99.52048486287248,
                    -7.327792333189458,
                    -6.479793643910213,
                    0,
                    -1.039294177120465,
                    -56.60488689961161,
                    -39.473372689066146,
                    1,
                    32.79999987057853,
                    90.34125761481833,
                    -27.61552337137781,
                    0,
                    -54.250559694530324,
                    -5.918300681562879,
                    -83.79651255160022,
                    0,
                    -77.3371874620183,
                    42.46681902292823,
                    47.0694260199326,
                    0,
                    26.42543336634083,
                    -45.21494056707623,
                    -54.40588591089278,
                    1,
                    16.77367774785457,
                    -14.951754974087827,
                    -97.44279855342765,
                    0,
                    -83.81499659057307,
                    -54.200607929807155,
                    -6.111201541686199,
                    0,
                    -51.900829802436334,
                    82.69668571385,
                    -21.623241584523495,
                    0,
                    27.10719651603963,
                    -47.10487001881852,
                    -60.44647310552897,
                    1,
                    16.773678593773433,
                    -14.951754635146434,
                    -97.442797309497,
                    0,
                    -83.81501125458973,
                    -54.20060556310355,
                    -6.111203607661435,
                    0,
                    -51.900836979355766,
                    82.69668704249747,
                    -21.6232430656113,
                    0,
                    27.10720013777003,
                    -47.10486474296685,
                    -60.44647298757252,
                    1,
                    -1.4044006469212842,
                    -2.5006464021789334,
                    -99.95891970534166,
                    0,
                    -8.199107313988804,
                    -99.62924513403155,
                    2.607730426336901,
                    0,
                    -99.65346102931268,
                    8.232498420024744,
                    1.1920728138693675,
                    0,
                    0.7568588922608352,
                    -24.945773699003595,
                    -51.472079583069146,
                    1,
                    25.76234261149901,
                    95.13350130835457,
                    16.910440851266543,
                    0,
                    2.485938816213146,
                    16.842657479278735,
                    -98.53985073177614,
                    0,
                    -96.59187113953412,
                    25.80941944431177,
                    1.975033119653328,
                    0,
                    4.624857632102524,
                    15.946484512535411,
                    -85.69318486604735,
                    1,
                    40.962547709165456,
                    91.22536323522509,
                    0.000987826480439935,
                    0,
                    0.0034541814187747377,
                    -0.0006561353805949466,
                    -99.99979775560152,
                    0,
                    -91.22398177712431,
                    40.96652467578747,
                    -0.002958931723864744,
                    0,
                    3.9778212932653716,
                    3.9004053124220963,
                    -87.92254746985209,
                    1,
                    40.962554992907755,
                    91.22534574096157,
                    0.0009610657613794427,
                    0,
                    0.003433005529672961,
                    -0.0006827501769652855,
                    -99.99979235927282,
                    0,
                    -91.22397607686386,
                    40.96653617269959,
                    -0.0029496245070133043,
                    0,
                    3.977810183194677,
                    3.9003946521510846,
                    -87.92253501104216,
                    1,
                    40.96256778299265,
                    91.22537450022347,
                    0.000960609284650138,
                    0,
                    0.0034332194485173773,
                    -0.0006822453122659056,
                    -99.9997922476826,
                    0,
                    -91.22398982058878,
                    40.966542772181555,
                    -0.0029498233910905114,
                    0,
                    3.9778057238368554,
                    3.9003951097119884,
                    -87.92255008496706,
                    1,
                    4.786795151729103,
                    -2.5626292846879775,
                    -99.85249476898869,
                    0,
                    16.148747588184648,
                    -98.63214075199741,
                    3.3057469805826636,
                    0,
                    -98.57145659846047,
                    -16.283511455319495,
                    -4.303448389329725,
                    0,
                    -2.165355432140414,
                    -25.11522650708726,
                    -51.067013162334874,
                    1,
                    -32.63109753078725,
                    93.39399043858583,
                    14.588504439334992,
                    0,
                    2.841738579810702,
                    16.395334020946375,
                    -98.60555497259784,
                    0,
                    -94.48152322009751,
                    -31.76721418425656,
                    -8.006816053665368,
                    0,
                    -7.0707918723541106,
                    15.251966487265966,
                    -85.0461688481436,
                    1,
                    -38.97029279098934,
                    92.0941127296903,
                    0.002062680569792974,
                    0,
                    -0.005766074019950551,
                    -0.0006347141164155801,
                    -99.99968368973576,
                    0,
                    -92.09136936578788,
                    -38.977579317875275,
                    0.004867670683665892,
                    0,
                    -10.021685489707536,
                    2.649712349814777,
                    -87.92263026061082,
                    1,
                    -38.970294831818464,
                    92.09411815299264,
                    0.0020848960345452028,
                    0,
                    -0.005772798944072122,
                    -0.0006209910938439478,
                    -99.99968362400092,
                    0,
                    -92.0913612503354,
                    -38.97757606778589,
                    0.004867898837798812,
                    0,
                    -10.021690279542277,
                    2.649725169247436,
                    -87.92261907747631,
                    1,
                    -38.97029755308607,
                    92.0941289640069,
                    0.0020881221764434965,
                    0,
                    -0.005772192872240289,
                    -0.0006172879949239984,
                    -99.99969603133691,
                    0,
                    -92.09138824087684,
                    -38.977585434293154,
                    0.004868667181069597,
                    0,
                    -10.021685507883184,
                    2.6497289815665592,
                    -87.92263776274186,
                    1
                ]
            };
        }else{
            material = new THREE.RawShaderMaterial({//原始着色器材质
                uniforms: {
                    text0: {type: 't', value: texs[0]}//textureHandle
                    ,text1: {type: 't', value: texs[1]}
                    ,text2: {type: 't', value: texs[2]}
                    ,text3: {type: 't', value: texs[3]}
                    ,text4: {type: 't', value: texs[4]}
                    ,text5: {type: 't', value: texs[5]}
                    ,text6: {type: 't', value: texs[6]}
                    ,text7: {type: 't', value: texs[7]}
                    ,text8: {type: 't', value: texs[8]}
                    ,text9: {type: 't', value: texs[9]}
                    ,text10: {type: 't', value: texs[10]}//textureHandle
                    ,text11: {type: 't', value: texs[11]}
                    ,text12: {type: 't', value: texs[12]}
                    ,text13: {type: 't', value: texs[13]}
                    ,text14: {type: 't', value: texs[14]}
                    ,text15: {type: 't', value: texs[15]}
                },
                vertexShader: document.getElementById('vertexShader0').textContent,
                fragmentShader: document.getElementById('fragmentShader0').textContent,
                side: THREE.DoubleSide
            });
        }

        this.mesh = new THREE.Mesh(geometry, material);//重要
        this.mesh.frustumCulled=false;

        if(this.haveSkeleton){
            this.handleSkeletonAnimation(this.animationClip);
            for(var i=0;i<this.originMeshs.length;i++){
                this.originMeshs[i].visible=false;
                this.obj.add(this.originMeshs[i]);//threeJS中模型的位置尺寸角度变化，似乎是通过骨骼来实现的
            }
            var scope=this;
            var skeletonMatrixInverse=[];//16*25//400
            for(i=0;i<scope.originMeshs[0].skeleton.boneInverses.length;i++){
                temp=scope.originMeshs[0].skeleton.boneInverses[i];
                temp=temp.toArray();
                for(j=0;j<temp.length;j++)
                    skeletonMatrixInverse.push(temp[j]);
            }
            scope.mesh.material.uniforms.skeletonMatrixInverse={value: skeletonMatrixInverse};
        }

        this.obj.add(this.mesh);

        //完成进行实例化渲染
    }
    this.handleSkeletonAnimation=function(animation){
        var scope=this;//scope范围//为了避免this重名
        updateAnimation();
        function updateAnimation() {//每帧更新一次动画
            requestAnimationFrame(updateAnimation);
            scope.time=(scope.time+1.0)%60000;
            scope.mesh.material.uniforms.time={value: scope.time};

            if(scope.time!==20.0)return;
            //开始计算matrix
            var data=[];
            for(var time=0;time<8;time++){//0-7
                matrixs0=[];matrixs=[];
                for(i=0;i<25;i++){
                    matrixs0.push(
                        compose(
                            animation.tracks[3*i+1].values[4*time],
                            animation.tracks[3*i+1].values[4*time+1],
                            animation.tracks[3*i+1].values[4*time+2],
                            animation.tracks[3*i+1].values[4*time+3],

                            animation.tracks[3*i+2].values[3*time],
                            animation.tracks[3*i+2].values[3*time+1],
                            animation.tracks[3*i+2].values[3*time+2],

                            animation.tracks[3*i].values[3*time],
                            animation.tracks[3*i].values[3*time+1],
                            animation.tracks[3*i].values[3*time+2]
                        )
                        //scope.originMeshs[0].skeleton.bones[i].matrix.clone()
                    );
                    matrixs.push(
                        scope.originMeshs[0].skeleton.boneInverses[i].clone()
                    );
                }

                //矩阵3没有乘以逆矩阵
                var tool=matrixs0[0];
                matrixs[0]=tool.clone().multiply(matrixs[0]);tool=tool.clone().multiply(matrixs0[1]);
                matrixs[1]=tool.clone().multiply(matrixs[1]);tool=tool.clone().multiply(matrixs0[2]);
                matrixs[2]=tool.clone().multiply(matrixs[2]);tool=tool.clone().multiply(matrixs0[3]);  var  _tool3=tool;



                tool=_tool3;
                tool=tool.clone().multiply(matrixs0[7]);
                matrixs[7]=tool.clone().multiply(matrixs[7]);tool=tool.clone().multiply(matrixs0[8]);
                matrixs[8]=tool.clone().multiply(matrixs[8]);tool=tool.clone().multiply(matrixs0[9]);
                matrixs[9]=tool.clone().multiply(matrixs[9]);tool=tool.clone().multiply(matrixs0[10]);
                matrixs[10]=tool.clone().multiply(matrixs[10]);

                tool=_tool3;
                tool=tool.clone().multiply(matrixs0[11]);
                matrixs[11]=tool.clone().multiply(matrixs[11]);tool=tool.clone().multiply(matrixs0[12]);
                matrixs[12]=tool.clone().multiply(matrixs[12]);tool=tool.clone().multiply(matrixs0[13]);
                matrixs[13]=tool.clone().multiply(matrixs[13]);tool=tool.clone().multiply(matrixs0[14]);
                matrixs[14]=tool.clone().multiply(matrixs[14]);

                var temp=[];
                temp.push(matrixs[7].toArray());
                temp.push(matrixs[8].toArray());
                temp.push(matrixs[9].toArray());
                temp.push(matrixs[10].toArray());
                temp.push(matrixs[11].toArray());
                temp.push(matrixs[12].toArray());
                temp.push(matrixs[13].toArray());
                temp.push(matrixs[14].toArray());
                for(var i=0;i<8;i++){
                    data.push(temp[i][0]);
                    data.push(temp[i][1]);
                    data.push(temp[i][2]);
                    data.push(temp[i][4]);
                    data.push(temp[i][5]);
                    data.push(temp[i][6]);
                    data.push(temp[i][8]);
                    data.push(temp[i][9]);
                    data.push(temp[i][10]);
                    data.push(temp[i][12]);
                    data.push(temp[i][13]);
                    data.push(temp[i][14]);
                }
            }//iii
            /*let link = document.createElement('a');
            link.style.display = 'none';
            document.body.appendChild(link);
            link.href = URL.createObjectURL(new Blob([JSON.stringify({data:data})], { type: 'text/plain' }));
            link.download ="skeletonData.json";
            console.log(data);
            //link.click();*/




        }
        function compose(x,y,z,w,sx,sy,sz,px,py,pz ) {
            var x2 = x + x,	y2 = y + y, z2 = z + z;
            var xx = x * x2, xy = x * y2, xz = x * z2;
            var yy = y * y2, yz = y * z2, zz = z * z2;
            var wx = w * x2, wy = w * y2, wz = w * z2;
            te = new THREE.Matrix4();
            te.set(
                ( 1.0-( yy + zz ) ) * sx,( xy - wz ) * sy        ,( xz + wy ) * sz        ,px,
                ( xy + wz ) * sx        ,( 1.0-( xx + zz ) ) * sy,( yz - wx ) * sz        ,py,
                ( xz - wy ) * sx        ,( yz + wx ) * sy        ,( 1.0-( xx + yy ) ) * sz,pz,
                0.0                     ,0.0                     ,0.0                     ,1.0
            );
            return te;
        }
    }

    this.updateBuffer=function(i){//更新第i个对象对应的缓冲区
        var pos=[
            this.mcol3.array[3*i  ],
            this.mcol3.array[3*i+1],
            this.mcol3.array[3*i+2]
        ];//记录位置
        this.dummy.scale.set(this.scales[i][0],this.scales[i][1],this.scales[i][2]);
        this.dummy.rotation.set(this.rotations[i][0],this.rotations[i][1],this.rotations[i][2]);
        this.dummy.updateMatrix();

        this.dummy.matrix.elements[12]=pos[0];
        this.dummy.matrix.elements[13]=pos[1];
        this.dummy.matrix.elements[14]=pos[2];//恢复位置
        this.setMatrix(i,this.dummy.matrix);
    }
    this.setMatrix=function (i,matrix){//获取实例化对象第i个成员的变换矩阵
        this.mcol0.array[3*i  ]=matrix.elements[0];
        this.mcol0.array[3*i+1]=matrix.elements[1];
        this.mcol0.array[3*i+2]=matrix.elements[2];

        this.mcol1.array[3*i  ]=matrix.elements[4];
        this.mcol1.array[3*i+1]=matrix.elements[5];
        this.mcol1.array[3*i+2]=matrix.elements[6];

        this.mcol2.array[3*i  ]=matrix.elements[8];
        this.mcol2.array[3*i+1]=matrix.elements[9];
        this.mcol2.array[3*i+2]=matrix.elements[10];

        this.mcol3.array[3*i  ]=matrix.elements[12];
        this.mcol3.array[3*i+1]=matrix.elements[13];
        this.mcol3.array[3*i+2]=matrix.elements[14];
    }
    this.getMatrix=function (i){//获取实例化对象第i个成员的变换矩阵
        var matrix=new THREE.Matrix4();
        matrix.set(
            this.mcol0.array[3*i  ],this.mcol1.array[3*i  ],this.mcol2.array[3*i  ],this.mcol3.array[3*i  ],
            this.mcol0.array[3*i+1],this.mcol1.array[3*i+1],this.mcol2.array[3*i+1],this.mcol3.array[3*i+1],
            this.mcol0.array[3*i+2],this.mcol1.array[3*i+2],this.mcol2.array[3*i+2],this.mcol3.array[3*i+2],
            0                      ,0                      ,0                      ,1
        );
        return matrix;
    }

    this.positionGet=function(i){
        return [this.mcol3.array[3*i],this.mcol3.array[3*i+1],this.mcol3.array[3*i+2]];
    }
    this.rotationGet=function(i){
        return this.rotations[i];
    }
    this.scaleGet=function(i){
        return this.scales[i];
    }

    this.typeSet=function (i,type) {
        this.type.array[4*i  ]=type[0];
        this.type.array[4*i+1]=type[1];
        this.type.array[4*i+2]=type[2];
        this.type.array[4*i+3]=type[3];
    }
    this.colorSet=function (i,color) {
        this.colors.array[3*i  ]=color[0];
        this.colors.array[3*i+1]=color[1];
        this.colors.array[3*i+2]=color[2];
    }
    this.positionSet=function (i,pos){
        this.mcol3.array[3*i  ]=pos[0];
        this.mcol3.array[3*i+1]=pos[1];
        this.mcol3.array[3*i+2]=pos[2];
    }
    this.rotationSet=function (i,rot){
        this.rotations[i][0]=rot[0];
        this.rotations[i][1]=rot[1];
        this.rotations[i][2]=rot[2];
        this.updateBuffer(i);
    }
    this.scaleSet=function(i,scale){
        this.scales[i][0]=scale[0];
        this.scales[i][1]=scale[1];
        this.scales[i][2]=scale[2];
        this.updateBuffer(i);
    }

    this.move=function (i,dPos){
        var pos=this.positionGet(i);
        this.positionSet(i,[pos[0]+dPos[0],pos[1]+dPos[1],pos[2]+dPos[2]]);
    }
    this.rotation=function (i,dRot){
        var rot=this.rotationGet(i);
        this.rotationSet(i,[rot[0]+dRot[0],rot[1]+dRot[1],rot[2]+dRot[2]]);
    }
}
function SkinnedMeshController() {
    var scope=this;
    this.mesh;
    this.animation;
    this.init=function (originMesh,animation) {
        this.animation=animation;
        this.mesh=originMesh.clone();//new THREE.SkinnedMesh(originMesh.geometry.clone(),originMesh.material)

        this.mesh.geometry=this.mesh.geometry.clone();
        this.mesh.material=this.mesh.material.clone();
        this.mesh.skeleton=this.mesh.skeleton.clone();
        this.mesh.matrixWorld=this.mesh.matrixWorld.clone();
        this.bones = [];
        cloneBones(this.mesh.skeleton.bones[0], this.bones);
        this.mesh.skeleton=new THREE.Skeleton(this.bones, this.mesh.skeleton.boneInverses);

        this.mesh.add(this.mesh.skeleton.bones[0]);//添加骨骼
        this.mesh.bind(this.mesh.skeleton,this.mesh.matrixWorld);//绑定骨架

        //搞清动画混合器AnimationMixer的作用至关重要
        //开始设置动画//进行这个动画设置的时候可能还只是一个基模
        var animationMixer0=new THREE.AnimationMixer(this.mesh);
        animationMixer0.clipAction(animation).play();//不清楚这里的作用


        //var t=0;
        //updateAnimation2_2();
        function updateAnimation3() {//每帧更新一次动画--失败
            t+=0.2;
            var time=Math.floor(t%36);

            //console.log(time);
            for(i=0;i<bones.length;i++) {
                //position
                x = animation.tracks[3 * i].values[3 * time];
                y = animation.tracks[3 * i].values[3 * time + 1];
                z = animation.tracks[3 * i].values[3 * time + 2];
                var m1 = new THREE.Matrix4();
                m1.set(
                    1, 0, 0, x,
                    0, 1, 0, y,
                    0, 0, 1, z,
                    0, 0, 0, 1
                );
                //var test=m1.clone();

                //Quaternion
                x = animation.tracks[3 * i + 1].values[4 * time];
                y = animation.tracks[3 * i + 1].values[4 * time + 1];
                z = animation.tracks[3 * i + 1].values[4 * time + 2];
                w = animation.tracks[3 * i + 1].values[4 * time + 3];
                var m2 = new THREE.Matrix4();
                m2.set(
                    1 - 2 * y * y - 2 * z * z, 2 * x * y - 2 * z * w, 2 * x * z + 2 * y * w, 0,
                    2 * x * y + 2 * z * w, 1 - 2 * x * x - 2 * z * z, 2 * y * z - 2 * x * w, 0,
                    2 * x * z - 2 * y * w, 2 * y * z + 2 * x * w, 1 - 2 * x * x - 2 * y * y, 0,
                    0, 0, 0, 1
                );
                //if(i===0)console.log(m2.elements[0])

                //scale
                x = animation.tracks[3 * i + 2].values[3 * time];
                y = animation.tracks[3 * i + 2].values[3 * time + 1];
                z = animation.tracks[3 * i + 2].values[3 * time + 2];
                var m3 = new THREE.Matrix4();
                m3.set(
                    x, 0, 0, 0,
                    0, y, 0, 0,
                    0, 0, z, 0,
                    0, 0, 0, 1
                );
                m1.multiply(m2.multiply(m3));
                //bones[i].matrix.copy(m1);
                for(j=0;j<16;j++){
                    bones[i].matrix.elements[j]=m1.elements[j]*50;
                    bones[i].matrixAutoUpdate=false;
                }
            }
            requestAnimationFrame(updateAnimation3);
        }
        function updateAnimation2_3() {//每帧更新一次动画
            t+=0.5;
            var time=Math.floor(t%36);
            for(i=0;i<bones.length;i++){
                bones[i].matrixAutoUpdate=false;
                bones[i].quaternion.copy(
                    new THREE.Quaternion(
                        animation.tracks[3*i+1].values[4*time],
                        animation.tracks[3*i+1].values[4*time+1],
                        animation.tracks[3*i+1].values[4*time+2],
                        animation.tracks[3*i+1].values[4*time+3]
                    )
                );
            }
            requestAnimationFrame(updateAnimation2_2);
        }
        function updateAnimation2_2() {//每帧更新一次动画--
            t+=0.5;//t=0;
            var time=Math.floor(t%36);
            scope.setTime(time);
            requestAnimationFrame(updateAnimation2_2);
        }
        function updateAnimation2_1() {//每帧更新一次动画
            t+=0.5;
            var time=Math.floor(t%36);

            for(i=0;i<bones.length;i++){
                bones[i].position.set(
                    animation.tracks[3*i].values[3*time],
                    animation.tracks[3*i].values[3*time+1],
                    animation.tracks[3*i].values[3*time+2]
                );
                bones[i].setRotationFromQuaternion(
                    new THREE.Quaternion(
                        animation.tracks[3*i+1].values[4*time],
                        animation.tracks[3*i+1].values[4*time+1],
                        animation.tracks[3*i+1].values[4*time+2],
                        animation.tracks[3*i+1].values[4*time+3]
                    )
                );
                bones[i].scale.set(
                    animation.tracks[3*i+2].values[3*time],
                    animation.tracks[3*i+2].values[3*time+1],
                    animation.tracks[3*i+2].values[3*time+2]
                );
                bones[i].matrix=compose(
                    bones[i].position, bones[i].quaternion, bones[i].scale
                );
                function compose( position, quaternion, scale ) {

                    //x,y,z,,w,sx,xy,xz,px,py,pz
                    const te = new THREE.Matrix4();

                    const x = quaternion._x, y = quaternion._y, z = quaternion._z, w = quaternion._w;
                    const x2 = x + x,	y2 = y + y, z2 = z + z;
                    const xx = x * x2, xy = x * y2, xz = x * z2;
                    const yy = y * y2, yz = y * z2, zz = z * z2;
                    const wx = w * x2, wy = w * y2, wz = w * z2;

                    const sx = scale.x, sy = scale.y, sz = scale.z;

                    te[ 0 ] = ( 1 - ( yy + zz ) ) * sx;
                    te[ 1 ] = ( xy + wz ) * sx;
                    te[ 2 ] = ( xz - wy ) * sx;
                    te[ 3 ] = 0;

                    te[ 4 ] = ( xy - wz ) * sy;
                    te[ 5 ] = ( 1 - ( xx + zz ) ) * sy;
                    te[ 6 ] = ( yz + wx ) * sy;
                    te[ 7 ] = 0;

                    te[ 8 ] = ( xz + wy ) * sz;
                    te[ 9 ] = ( yz - wx ) * sz;
                    te[ 10 ] = ( 1 - ( xx + yy ) ) * sz;
                    te[ 11 ] = 0;

                    te[ 12 ] = position.x;
                    te[ 13 ] = position.y;
                    te[ 14 ] = position.z;
                    te[ 15 ] = 1;
                    return te;
                }
            }
            requestAnimationFrame(updateAnimation2_1);
        }
        function updateAnimation2() {//每帧更新一次动画
            t+=0.2;
            var time=Math.floor(t%36);

            for(i=0;i<bones.length;i++){
                bones[i].position.set(
                    animation.tracks[3*i].values[3*time],
                    animation.tracks[3*i].values[3*time+1],
                    animation.tracks[3*i].values[3*time+2]
                );
                bones[i].setRotationFromQuaternion(
                    new THREE.Quaternion(
                        animation.tracks[3*i+1].values[4*time],
                        animation.tracks[3*i+1].values[4*time+1],
                        animation.tracks[3*i+1].values[4*time+2],
                        animation.tracks[3*i+1].values[4*time+3]
                    )
                );
                bones[i].scale.set(
                    animation.tracks[3*i+2].values[3*time],
                    animation.tracks[3*i+2].values[3*time+1],
                    animation.tracks[3*i+2].values[3*time+2]
                );
                bones[i].updateMatrix();
            }
            requestAnimationFrame(updateAnimation2);
        }
        function updateAnimation() {//每帧更新一次动画
            animationMixer0.update(0.05);
            requestAnimationFrame(updateAnimation);
        }

        function cloneBones(rootBone , boneArray){//用于加载完gltf文件后的骨骼动画的处理
            var rootBoneClone=rootBone.clone();
            rootBoneClone.children.splice(0,rootBoneClone.children.length);
            boneArray.push(rootBoneClone);
            for (var i = 0 ; i < rootBone.children.length ; ++i)
                rootBoneClone.add(cloneBones(rootBone.children[i], boneArray));
            return rootBoneClone;
        }
    }
    this.setTime=function (time) {
        var animation=this.animation;
        var bones=this.bones;
        for(i=0;i<bones.length;i++){
            bones[i].matrixAutoUpdate=false;
            bones[i].matrix=scope.compose(
                animation.tracks[3*i+1].values[4*time],
                animation.tracks[3*i+1].values[4*time+1],
                animation.tracks[3*i+1].values[4*time+2],
                animation.tracks[3*i+1].values[4*time+3],

                animation.tracks[3*i+2].values[3*time],
                animation.tracks[3*i+2].values[3*time+1],
                animation.tracks[3*i+2].values[3*time+2],

                animation.tracks[3*i].values[3*time],
                animation.tracks[3*i].values[3*time+1],
                animation.tracks[3*i].values[3*time+2]
            );
        }
    }
    this.compose=function(x,y,z,w,sx,sy,sz,px,py,pz) {
        var x2 = x + x,	y2 = y + y, z2 = z + z;
        var xx = x * x2, xy = x * y2, xz = x * z2;
        var yy = y * y2, yz = y * z2, zz = z * z2;
        var wx = w * x2, wy = w * y2, wz = w * z2;
        te = new THREE.Matrix4();
        te.set(
            ( 1.0-( yy + zz ) ) * sx,( xy - wz ) * sy        ,( xz + wy ) * sz        ,px,
            ( xy + wz ) * sx        ,( 1.0-( xx + zz ) ) * sy,( yz - wx ) * sz        ,py,
            ( xz - wy ) * sx        ,( yz + wx ) * sy        ,( 1.0-( xx + yy ) ) * sz,pz,
            0.0                     ,0.0                     ,0.0                     ,1.0
        );
        return te;
    }
}